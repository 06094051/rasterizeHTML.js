/*! rasterizeHTML.js - v0.3.0 - 2013-02-24
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2013 Christoph Burgmer; Licensed MIT */
window.rasterizeHTMLInline=function(e,t,n){"use strict";var r={};r.util={},r.util.cloneArray=function(e){return Array.prototype.slice.apply(e,[0])},r.util.joinUrl=function(e,n){var r=new t(n);return r.is("relative")&&(r=r.absoluteTo(e)),r.toString()},r.util.isDataUri=function(e){return/^data:/.test(e)},r.util.map=function(e,t,n){var i=0,s=r.util.cloneArray(e),o=[],u;s.length===0&&n(o);var a=function(e){function r(t){i+=1,o[e]=t,i===s.length&&n(o)}t(s[e],r)};for(u=0;u<s.length;u++)a(u)};var i=function(e){return e+"?_="+Date.now()};r.util.ajax=function(t,n,r,s){var o=new e.XMLHttpRequest,u;n=n||{},u=n.cache===!1?i(t):t,o.addEventListener("load",function(){o.status===200||o.status===0?r(o.response):s()},!1),o.addEventListener("error",function(){s()},!1),o.open("GET",u,!0),o.overrideMimeType(n.mimeType);try{o.send(null)}catch(a){s()}},r.util.binaryAjax=function(e,t,n,i){var s="";t=t||{},r.util.ajax(e,{mimeType:"text/plain; charset=x-user-defined",cache:t.cache},function(e){for(var t=0;t<e.length;t++)s+=String.fromCharCode(e.charCodeAt(t)&255);n(s)},i)};var s=function(e){var t=/^"(.*)"$/,n=/^'(.*)'$/;return t.test(e)?e.replace(t,"$1"):n.test(e)?e.replace(n,"$1"):e},o=function(e){var t=/^[\t\r\f\n ]*(.+?)[\t\r\f\n ]*$/;return e.replace(t,"$1")};r.util.extractCssUrl=function(e){var t=/^url\(([^\)]+)\)/,n;if(!t.test(e))throw new Error("Invalid url");return n=t.exec(e)[1],s(o(n))};var u=function(e){var t=function(e,t){return e.substring(0,t.length)===t};return t(e,"<?xml")||t(e,"<svg")?"image/svg+xml":"image/png"};r.util.getDataURIForImageURL=function(e,t,n,i){var s,o;r.util.binaryAjax(e,t,function(e){s=btoa(e),o=u(e),n("data:"+o+";base64,"+s)},function(){i()})};var a=function(e,t){return t&&t!=="about:blank"&&(e=r.util.joinUrl(t,e)),e},f=function(e){var t=new n,r=t.parse(e,!1,!0);return r},l=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspSTYLE_RULE)for(i=0;i<s.declarations.length;i++)s.declarations[i].property==="background-image"&&n.push(s.declarations[i])}return n},c=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspFONT_FACE_RULE)for(i=0;i<s.descriptors.length;i++)s.descriptors[i].property==="src"&&n.push(s.descriptors[i])}return n},h=function(t){var n="",r,i,s;for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspSTYLE_RULE){n+=s.selectorText()+" {\n";for(i=0;i<s.declarations.length;i++)s.declarations[i].property==="background-image"?n+=s.declarations[i].cssText()+"\n":n+=s.declarations[i].property+": "+s.declarations[i].valueText+";\n";n+="}\n"}else n+=s.cssText()+"\n"}return n},p=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},d=function(e){return typeof e=="function"};r.util.parseOptionalParameters=function(){var e={options:{},callback:null};return d(arguments[0])?e.callback=arguments[0]:(e.options=p(arguments[0]),e.callback=arguments[1]||null),e};var v=function(e,t,n,i,s){var o=e.attributes.src.nodeValue,u=t||e.ownerDocument.baseURI;if(r.util.isDataUri(o)){i();return}o=a(o,u),r.util.getDataURIForImageURL(o,{cache:n},function(t){e.attributes.src.nodeValue=t,i()},function(){s(o)})},m=function(e){var t=[];return Array.prototype.forEach.call(e,function(e){e.type==="image"&&t.push(e)}),t};r.loadAndInlineImages=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("img"),o=e.getElementsByTagName("input"),u=i.options.baseUrl,a=i.options.cache!==!1,f=[],l=[];f=Array.prototype.slice.call(s),f=f.concat(m(o)),r.util.map(f,function(e,t){v(e,u,a,t,function(e){l.push({resourceType:"image",url:e}),t()})},function(){i.callback&&i.callback(l)})};var g=function(e,t){var n,i,s=!1;for(i=0;i<t.values.length;i++){try{n=r.util.extractCssUrl(t.values[i].cssText())}catch(o){continue}if(r.util.isDataUri(n))continue;n=r.util.joinUrl(e,n),t.values[i].setCssText('url("'+n+'")'),s=!0}return s},y=function(e,t){var n=f(t),r=[],i=!1,s;r=r.concat(l(n)),r=r.concat(c(n));for(s=0;s<r.length;s++)i=g(e,r[s])||i;return i?h(n):t},b=function(e,t){var n=e.parentNode,r;t=t.trim(),t&&(r=e.ownerDocument.createElement("style"),r.type="text/css",r.appendChild(e.ownerDocument.createTextNode(t)),n.insertBefore(r,e)),n.removeChild(e)},w=function(e,t,n,i,s){var o=e.attributes.href.nodeValue,u=t||e.ownerDocument.baseURI,f=a(o,u),l;r.util.ajax(f,{cache:n},function(e){l=y(o,e),i(l)},function(){s(f)})};r.loadAndInlineCSS=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("link"),o=i.options.baseUrl,u=i.options.cache!==!1,a=[];r.util.map(s,function(e,t){e.attributes.rel&&e.attributes.rel.nodeValue==="stylesheet"&&(!e.attributes.type||e.attributes.type.nodeValue==="text/css")?w(e,o,u,function(n){b(e,n+"\n"),t()},function(e){a.push({resourceType:"stylesheet",url:e}),t()}):t()},function(){i.callback&&i.callback(a)})};var E=function(t){var n=[],r,i;for(r=0;r<t.cssRules.length;r++)i=t.cssRules[r],i.type===e.kJscsspIMPORT_RULE&&n.push(i);return n},S=function(e){return{cssText:function(){return e}}},x=function(e,t,n){var r=y(t,n),i=S(r),s=e.parentStyleSheet,o=s.cssRules.indexOf(e);s.cssRules.splice(o,1,i)},T=function(e){var t=/^"(.*)"$/,n=/^'(.*)'$/;return t.test(e)||n.test(e)},N=function(e,t,n,i,o,u){var f=e.href,l,c;if(T(f))c=s(f);else try{c=r.util.extractCssUrl(f)}catch(h){o(!1);return}l=a(c,t);if(i.indexOf(l)>=0){x(e,c,""),o(!0,[]);return}i.push(l),r.util.ajax(l,{cache:n},function(r){C(r,t,n,i,function(t,n){x(e,c,t),o(!0,n)})},function(){u(l)})},C=function(e,t,n,i,s){var o=f(e),u=[],a;if(!o){s(e,u);return}a=E(o),r.util.map(a,function(e,r){N(e,t,n,i,function(e,t){u=u.concat(t),r(e)},function(e){u.push({resourceType:"stylesheet",url:e}),r()})},function(t){t.indexOf(!0)>=0&&(e=h(o).trim()),s(e,u)})},k=function(e,t,n,r,i){C(e.textContent,t,n,r,function(t,n){e.textContent!==t&&(e.childNodes[0].nodeValue=t),i(n)})};r.loadAndInlineCSSImports=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("style"),o=i.options.baseUrl||e.baseURI,u=i.options.cache!==!1,a=[],f=[];r.util.map(s,function(e,t){!e.attributes.type||e.attributes.type.nodeValue==="text/css"?k(e,o,u,f,function(e){a=a.concat(e),t()}):t()},function(){i.callback(a)})};var L=function(e,t,n,i){var s=!1,o=[],u=0,f,l=function(){u+=1,u===e.values.length&&i(s,o)};e.values.forEach(function(i,u){try{f=r.util.extractCssUrl(e.values[u].cssText())}catch(c){l();return}if(r.util.isDataUri(f)){l();return}f=a(f,t),r.util.getDataURIForImageURL(f,{cache:n},function(t){e.values[u].setCssText('url("'+t+'")'),s=!0,l()},function(){o.push(f),l()})})},A=function(e,t,n,i){var s=l(e),o=[],u;r.util.map(s,function(e,r){L(e,t,n,function(e,t){t.forEach(function(e){o.push({resourceType:"backgroundImage",url:e})}),r(e)})},function(e){u=e.indexOf(!0)>=0,i(u,o)})},O=function(e){var t=/^format\(([^\)]+)\)/,n;return t.test(e)?(n=t.exec(e)[1],s(n)):null},M=function(e){var t,n,i=null;for(t=0;t<e.length;t++)try{return n=r.util.extractCssUrl(e[t].cssText()),t+1<e.length&&(i=O(e[t+1].cssText())),{url:n,format:i}}catch(s){}},_=function(e,t,n,i,s){var o,u,f,l;o=M(e.values);if(!o){i(!1);return}if(r.util.isDataUri(o.url)){i(!1);return}u=a(o.url,t),f=o.format?o.format:"woff",r.util.binaryAjax(u,{cache:n},function(t){l=btoa(t),e.values[0].setCssText('url("data:font/'+f+";base64,"+l+'")'),i(!0)},function(){s(u)})},D=function(e,t,n,i){var s=c(e),o=[],u;r.util.map(s,function(e,r){_(e,t,n,r,function(e){o.push({resourceType:"fontFace",url:e}),r()})},function(e){u=e.indexOf(!0)>=0,i(u,o)})},P=function(t,n){var r=l(n).length+c(n).length>0;return r&&e.navigator.userAgent.indexOf("WebKit")>=0?"span {}\n"+t:t},H=function(e,t,n,r){var i=e.textContent,s=t||e.ownerDocument.baseURI,o=f(i);A(o,s,n,function(t,u){D(o,s,n,function(n,s){if(t||n)i=h(o);i=P(i,o),e.childNodes[0].nodeValue=i,r(u.concat(s))})})};r.loadAndInlineCSSReferences=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=[],o=i.options.baseUrl,u=i.options.cache!==!1,a=e.getElementsByTagName("style");r.util.map(a,function(e,t){!e.attributes.type||e.attributes.type.nodeValue==="text/css"?H(e,o,u,function(e){s=s.concat(e),t()}):t()},function(){i.callback&&i.callback(s)})};var B=function(e,t,n,i,s){var o=t||e.ownerDocument.baseURI,u=a(e.attributes.src.nodeValue,o);r.util.ajax(u,{cache:n},i,function(){s(u)})},j=function(e,t){var n=e.ownerDocument.createElement("script"),r=e.parentNode;e.attributes.type&&(n.type=e.attributes.type.nodeValue),n.appendChild(e.ownerDocument.createTextNode(t)),r.insertBefore(n,e),r.removeChild(e)};return r.loadAndInlineScript=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("script"),o=i.options.cache!==!1,u=[];r.util.map(s,function(e,t){e.attributes.src?B(e,i.options.baseUrl,o,function(n){j(e,n),t()},function(e){u.push({resourceType:"script",url:e}),t()}):t()},function(){i.callback&&i.callback(u)})},r.inlineReferences=function(e,t,n){var i=[];r.loadAndInlineImages(e,t,function(s){i=i.concat(s),r.loadAndInlineCSS(e,t,function(s){i=i.concat(s),r.loadAndInlineCSSImports(e,t,function(s){i=i.concat(s),r.loadAndInlineCSSReferences(e,t,function(s){i=i.concat(s),r.loadAndInlineScript(e,t,function(e){i=i.concat(e),n(i)})})})})})},r}(window,URI,CSSParser),window.rasterizeHTML=function(e,t){"use strict";var n={},r=[];n.util={},n.util.getConstantUniqueIdFor=function(e){return r.indexOf(e)<0&&r.push(e),r.indexOf(e)},n.util.log=function(e){t.console&&t.console.log&&t.console.log(e)};var i=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},s=function(e){return typeof e=="object"&&e!==null},o=function(e){return s(e)&&Object.prototype.toString.apply(e).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},u=function(e){return typeof e=="function"};n.util.parseOptionalParameters=function(){var e={canvas:null,options:{},callback:null};return u(arguments[0])?e.callback=arguments[0]:arguments[0]==null||o(arguments[0])?(e.canvas=arguments[0]||null,u(arguments[1])?e.callback=arguments[1]:(e.options=i(arguments[1]),e.callback=arguments[2]||null)):(e.options=i(arguments[0]),e.callback=arguments[1]||null),e};var a=function(e){return(""+function(e){window.parent.rasterizeHTML.util.reportIframeJsError("put_unique_id_here",e)}).replace("put_unique_id_here",e)},f={};n.util.reportIframeJsError=function(e,t){var n=f[e]||[];n.push(t),f[e]=n};var l=function(e){var t=[];return f[e]&&f[e].forEach(function(e){t.push({resourceType:"script",msg:e})}),t};n.util.executeJavascript=function(e,r,i){var s=g(t.document,"iframe"),o=e.getElementsByTagName("html")[0].innerHTML,u=n.util.getConstantUniqueIdFor(e),f="<script>window.onerror = "+a(u)+";</script>",c=function(){var e=s.contentDocument;t.document.getElementsByTagName("body")[0].removeChild(s),i(e,l(u))};r>0?s.onload=function(){setTimeout(c,r)}:s.onload=c,s.contentDocument.open(),s.contentDocument.write("<html>"+f+o+"</html>"),s.contentDocument.close()};var c=function(){return t.navigator.userAgent.indexOf("WebKit")>=0},h=function(e){var r;return e.documentElement.setAttribute("xmlns",e.documentElement.namespaceURI),r=(new t.XMLSerializer).serializeToString(e.documentElement),c()?t.HTMLtoXML?t.HTMLtoXML(r):(n.util.log("Looks like your browser needs htmlparser.js as workaround for writing XML. Please include it."),r):r},p=function(){if(t.navigator.userAgent.indexOf("WebKit")>=0&&t.navigator.userAgent.indexOf("Chrome")<0)return!1;if(t.BlobBuilder||t.MozBlobBuilder||t.WebKitBlobBuilder)return!0;if(t.Blob)try{return new t.Blob("<b></b>",{type:"text/xml"}),!0}catch(e){return!1}return!1},d=function(e){var n="image/svg+xml;charset=utf-8",r=t.BlobBuilder||t.MozBlobBuilder||t.WebKitBlobBuilder,i;return r?(i=new r,i.append(e),i.getBlob(n)):new t.Blob(e,{type:n})},v=function(e){var n=t.URL||t.webkitURL||window;return p()?n.createObjectURL(d(e)):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)},m=function(e){var n=t.URL||t.webkitURL||window;p()&&n.revokeObjectURL(e)},g=function(e,t){var n=e.createElement(t);return n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.style.position="absolute",n.style.top="-10000px",n.style.left="-10000px",e.getElementsByTagName("body")[0].appendChild(n),n},y=function(e,t){var n=e.getElementById(t);return n||(n=g(e,"div"),n.id=t),n},b="rasterizeHTML_js_FirefoxWorkaround",w=function(){var e=t.navigator.userAgent.match(/Firefox\/(\d+).0/);return!e||!e[1]||parseInt(e[1],10)<17},E=function(e,r){var i=n.util.getConstantUniqueIdFor(e),s=r?r.ownerDocument:t.document,o;w()&&(o=y(s,b+i),o.innerHTML=e,o.className=b)},S=function(e,r){var i=n.util.getConstantUniqueIdFor(e),s=r?r.ownerDocument:t.document,o=s.getElementById(b+i);o&&o.parentNode.removeChild(o)};n.getSvgForDocument=function(e,t,n){var r=h(e);return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+n+'">'+'<foreignObject width="100%" height="100%">'+r+"</foreignObject>"+"</svg>"},n.renderSvg=function(e,n,r,i){var s,o,u=function(){o.onload=null,o.onerror=null},a=function(){s&&m(s),S(e,n)};E(e,n),s=v(e),o=new t.Image,o.onload=function(){u(),a(),r(o)},o.onerror=function(){a(),i()},o.src=s},n.drawImageOnCanvas=function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(n){return!1}return!0};var x=function(e,t,r,i,s,o){var u=n.getSvgForDocument(e,t,r),a=function(e){e.push({resourceType:"document"})},f;n.renderSvg(u,i,function(e){i&&(f=n.drawImageOnCanvas(e,i),f||(a(o),e=null)),s&&s(e,o)},function(){a(o),s&&s(null,o)})};return n.drawDocument=function(t,r,i,s){var o=n.util.parseOptionalParameters(r,i,s),u=o.canvas?o.canvas.width:300,a=o.canvas?o.canvas.height:200,f=o.options.width!==undefined?o.options.width:u,l=o.options.height!==undefined?o.options.height:a,c=o.options.executeJsTimeout||0;e.inlineReferences(t,o.options,function(e){o.options.executeJs?n.util.executeJavascript(t,c,function(t,n){x(t,f,l,o.canvas,o.callback,e.concat(n))}):x(t,f,l,o.canvas,o.callback,e)})},n.drawHTML=function(e,r,i,s){var o=n.util.parseOptionalParameters(r,i,s),u=t.document.implementation.createHTMLDocument("");u.documentElement.innerHTML=e,n.drawDocument(u,o.canvas,o.options,o.callback)},n.drawURL=function(t,r,i,s){var o=n.util.parseOptionalParameters(r,i,s),u=o.options.cache;o.options.baseUrl=t,e.util.ajax(t,{cache:u},function(e){n.drawHTML(e,o.canvas,o.options,o.callback)},function(){o.callback&&o.callback(null,[{resourceType:"page",url:t}])})},n}(window.rasterizeHTMLInline,window);