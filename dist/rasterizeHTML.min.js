/*! rasterizeHTML.js - v0.3.0 - 2013-03-25
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2013 Christoph Burgmer; Licensed MIT */
window.rasterizeHTMLInline=function(e){"use strict";var t=function(t,n,r,i,s){var o=t.attributes.src.nodeValue,u=n||t.ownerDocument.baseURI;if(e.util.isDataUri(o)){i();return}o=e.util.getUrlRelativeToDocumentBase(o,u),e.util.getDataURIForImageURL(o,{cache:r},function(e){t.attributes.src.nodeValue=e,i()},function(){s(o)})},n=function(e){var t=[];return Array.prototype.forEach.call(e,function(e){e.type==="image"&&t.push(e)}),t};e.loadAndInlineImages=function(r,i,s){var o=e.util.parseOptionalParameters(i,s),u=r.getElementsByTagName("img"),a=r.getElementsByTagName("input"),f=o.options.baseUrl,l=o.options.cache!==!1,c=[],h=[];c=Array.prototype.slice.call(u),c=c.concat(n(a)),e.util.map(c,function(e,n){t(e,f,l,n,function(e){h.push({resourceType:"image",url:e,msg:"Unable to load image "+e}),n()})},function(){o.callback&&o.callback(h)})};var r=function(t,n,r,i,s){var o=e.rulesForCssText(t.textContent);e.loadCSSImportsForRules(o,n,r,i,function(i,u){e.loadAndInlineCSSResourcesForRules(o,n,r,function(n,r){var a=u.concat(r),f;i||n?f=e.cssRulesToText(o):f=t.textContent,f=e.workAroundWebkitBugIgnoringTheFirstRuleInCSS(f,o),t.childNodes[0].nodeValue=f,s(a)})})};e.loadAndInlineStyles=function(t,n,i){var s=e.util.parseOptionalParameters(n,i),o=t.getElementsByTagName("style"),u=s.options.baseUrl||t.baseURI,a=s.options.cache!==!1,f=[],l=[];e.util.map(o,function(e,t){!e.attributes.type||e.attributes.type.nodeValue==="text/css"?r(e,u,a,l,function(e){f=f.concat(e),t()}):t()},function(){s.callback(f)})};var i=function(e,t){var n=e.parentNode,r;t=t.trim(),t&&(r=e.ownerDocument.createElement("style"),r.type="text/css",r.appendChild(e.ownerDocument.createTextNode(t)),n.insertBefore(r,e)),n.removeChild(e)},s=function(t,n,r,i,s){var o=t.attributes.href.nodeValue,u=n||t.ownerDocument.baseURI,a=e.util.getUrlRelativeToDocumentBase(o,u);e.util.ajax(a,{cache:r},function(t){var n=e.rulesForCssText(t),s;s=e.adjustPathsOfCssResources(o,n),e.loadCSSImportsForRules(n,u,r,[],function(o,a){e.loadAndInlineCSSResourcesForRules(n,u,r,function(r,u){var f=a.concat(u);if(s||o||r)t=e.cssRulesToText(n);t=e.workAroundWebkitBugIgnoringTheFirstRuleInCSS(t,n),i(t,f)})})},function(){s(a)})};e.loadAndInlineCssLinks=function(t,n,r){var o=e.util.parseOptionalParameters(n,r),u=t.getElementsByTagName("link"),a=o.options.baseUrl,f=o.options.cache!==!1,l=[];e.util.map(u,function(e,t){e.attributes.rel&&e.attributes.rel.nodeValue==="stylesheet"&&(!e.attributes.type||e.attributes.type.nodeValue==="text/css")?s(e,a,f,function(n,r){i(e,n+"\n"),l=l.concat(r),t()},function(e){l.push({resourceType:"stylesheet",url:e,msg:"Unable to load stylesheet "+e}),t()}):t()},function(){o.callback&&o.callback(l)})};var o=function(t,n,r,i,s){var o=n||t.ownerDocument.baseURI,u=e.util.getUrlRelativeToDocumentBase(t.attributes.src.nodeValue,o);e.util.ajax(u,{cache:r},i,function(){s(u)})},u=function(e,t){var n=e.ownerDocument.createElement("script"),r=e.parentNode;e.attributes.type&&(n.type=e.attributes.type.nodeValue),n.appendChild(e.ownerDocument.createTextNode(t)),r.insertBefore(n,e),r.removeChild(e)};return e.loadAndInlineScript=function(t,n,r){var i=e.util.parseOptionalParameters(n,r),s=t.getElementsByTagName("script"),a=i.options.cache!==!1,f=[];e.util.map(s,function(e,t){e.attributes.src?o(e,i.options.baseUrl,a,function(n){u(e,n),t()},function(e){f.push({resourceType:"script",url:e,msg:"Unable to load script "+e}),t()}):t()},function(){i.callback&&i.callback(f)})},e.inlineReferences=function(t,n,r){var i=[];e.loadAndInlineImages(t,n,function(s){i=i.concat(s),e.loadAndInlineStyles(t,n,function(s){i=i.concat(s),e.loadAndInlineCssLinks(t,n,function(s){i=i.concat(s),e.loadAndInlineScript(t,n,function(e){i=i.concat(e),r(i)})})})})},e}(window.rasterizeHTMLInline||{}),window.rasterizeHTML=function(e,t,n){"use strict";var r={},i=[];r.util={},r.util.getConstantUniqueIdFor=function(e){return i.indexOf(e)<0&&i.push(e),i.indexOf(e)},r.util.log=function(e){n.console&&n.console.log&&n.console.log(e)};var s=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},o=function(e){return typeof e=="object"&&e!==null},u=function(e){return o(e)&&Object.prototype.toString.apply(e).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},a=function(e){return typeof e=="function"};r.util.parseOptionalParameters=function(){var e={canvas:null,options:{},callback:null};return a(arguments[0])?e.callback=arguments[0]:arguments[0]==null||u(arguments[0])?(e.canvas=arguments[0]||null,a(arguments[1])?e.callback=arguments[1]:(e.options=s(arguments[1]),e.callback=arguments[2]||null)):(e.options=s(arguments[0]),e.callback=arguments[1]||null),e};var f=function(e){return(""+function(e){window.parent.rasterizeHTML.util.reportIframeJsError("put_unique_id_here",e)}).replace("put_unique_id_here",e)},l={};r.util.reportIframeJsError=function(e,t){var n=l[e]||[];n.push(t),l[e]=n};var c=function(e){var t=[];return l[e]&&l[e].forEach(function(e){t.push({resourceType:"scriptExecution",msg:e})}),t};r.util.executeJavascript=function(e,t,i){var s=y(n.document,"iframe"),o=e.getElementsByTagName("html")[0].innerHTML,u=r.util.getConstantUniqueIdFor(e),a="<script>window.onerror = "+f(u)+";</script>",l=function(){var e=s.contentDocument;n.document.getElementsByTagName("body")[0].removeChild(s),i(e,c(u))};t>0?s.onload=function(){setTimeout(l,t)}:s.onload=l,s.contentDocument.open(),s.contentDocument.write("<html>"+a+o+"</html>"),s.contentDocument.close()};var h=function(){return n.navigator.userAgent.indexOf("WebKit")>=0},p=function(e){var i;return e.documentElement.setAttribute("xmlns",e.documentElement.namespaceURI),i=(new n.XMLSerializer).serializeToString(e.documentElement),h()?t?t(i):(r.util.log("Looks like your browser needs htmlparser.js as workaround for writing XML. Please include it."),i):i},d=function(){if(n.navigator.userAgent.indexOf("WebKit")>=0&&n.navigator.userAgent.indexOf("Chrome")<0)return!1;if(n.BlobBuilder||n.MozBlobBuilder||n.WebKitBlobBuilder)return!0;if(n.Blob)try{return new n.Blob(["<b></b>"],{type:"text/xml"}),!0}catch(e){return!1}return!1},v=function(e){var t="image/svg+xml;charset=utf-8",r=n.BlobBuilder||n.MozBlobBuilder||n.WebKitBlobBuilder,i;return r?(i=new r,i.append(e),i.getBlob(t)):new n.Blob([e],{type:t})},m=function(e){var t=n.URL||n.webkitURL||window;return d()?t.createObjectURL(v(e)):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)},g=function(e){var t=n.URL||n.webkitURL||window;d()&&t.revokeObjectURL(e)},y=function(e,t){var n=e.createElement(t);return n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.style.position="absolute",n.style.top="-10000px",n.style.left="-10000px",e.getElementsByTagName("body")[0].appendChild(n),n},b=function(e,t){var n=e.getElementById(t);return n||(n=y(e,"div"),n.id=t),n},w="rasterizeHTML_js_FirefoxWorkaround",E=function(){var e=n.navigator.userAgent.match(/Firefox\/(\d+).0/);return!e||!e[1]||parseInt(e[1],10)<17},S=function(e,t){var i=r.util.getConstantUniqueIdFor(e),s=t?t.ownerDocument:n.document,o;E()&&(o=b(s,w+i),o.innerHTML=e,o.className=w)},x=function(e,t){var i=r.util.getConstantUniqueIdFor(e),s=t?t.ownerDocument:n.document,o=s.getElementById(w+i);o&&o.parentNode.removeChild(o)};r.getSvgForDocument=function(e,t,n){var r=p(e);return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+n+'">'+'<foreignObject width="100%" height="100%">'+r+"</foreignObject>"+"</svg>"},r.renderSvg=function(e,t,r,i){var s,o,u=function(){o.onload=null,o.onerror=null},a=function(){s&&g(s),x(e,t)};S(e,t),s=m(e),o=new n.Image,o.onload=function(){u(),a(),r(o)},o.onerror=function(){a(),i()},o.src=s},r.drawImageOnCanvas=function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(n){return!1}return!0};var T=function(e,t,n,i,s,o){var u=r.getSvgForDocument(e,t,n),a=function(e){e.push({resourceType:"document",msg:"Error rendering page"})},f;r.renderSvg(u,i,function(e){i&&(f=r.drawImageOnCanvas(e,i),f||(a(o),e=null)),s&&s(e,o)},function(){a(o),s&&s(null,o)})};return r.drawDocument=function(t,n,i,s){var o=r.util.parseOptionalParameters(n,i,s),u=o.canvas?o.canvas.width:300,a=o.canvas?o.canvas.height:200,f=o.options.width!==undefined?o.options.width:u,l=o.options.height!==undefined?o.options.height:a,c=o.options.executeJsTimeout||0;e.inlineReferences(t,o.options,function(e){o.options.executeJs?r.util.executeJavascript(t,c,function(t,n){T(t,f,l,o.canvas,o.callback,e.concat(n))}):T(t,f,l,o.canvas,o.callback,e)})},r.drawHTML=function(e,t,i,s){var o=r.util.parseOptionalParameters(t,i,s),u=n.document.implementation.createHTMLDocument("");u.documentElement.innerHTML=e,r.drawDocument(u,o.canvas,o.options,o.callback)},r.drawURL=function(t,n,i,s){var o=r.util.parseOptionalParameters(n,i,s),u=o.options.cache;o.options.baseUrl=t,e.util.ajax(t,{cache:u},function(e){r.drawHTML(e,o.canvas,o.options,o.callback)},function(){o.callback&&o.callback(null,[{resourceType:"page",url:t,msg:"Unable to load page "+t}])})},r}(window.rasterizeHTMLInline,window.HTMLtoXML,window);