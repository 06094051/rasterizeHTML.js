/*! rasterizeHTML.js - v0.1.0 - 2012-09-16
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2012 Christoph Burgmer; Licensed MIT */
var rasterizeHTML=function(){"use strict";var e={},t=[];e.util={},e.util.getConstantUniqueIdFor=function(e){return t.indexOf(e)<0&&t.push(e),t.indexOf(e)},e.util.cloneArray=function(e){return Array.prototype.slice.apply(e,[0])},e.util.log=function(e){window.console&&window.console.log&&window.console.log(e)},e.util.joinUrl=function(e,t){var n=new URI(t);return n.is("relative")&&(n=n.absoluteTo(e)),n.toString()},e.util.isDataUri=function(e){return/^data:/.test(e)},e.util.map=function(t,n,r){var i=0,s=e.util.cloneArray(t),o=[],u;s.length===0&&r(o);var a=function(e){function t(t){i+=1,o[e]=t,i===s.length&&r(o)}n(s[e],t)};for(u=0;u<s.length;u++)a(u)},e.util.ajax=function(e,t,n,r){var i=new window.XMLHttpRequest;i.addEventListener("load",function(e){i.status===200||i.status===0?t(i.response):n()},!1),i.addEventListener("error",function(){n()},!1),i.open("GET",e,!0),i.overrideMimeType(r);try{i.send(null)}catch(s){n()}},e.util.binaryAjax=function(t,n,r){var i="";e.util.ajax(t,function(e){for(var t=0;t<e.length;t++)i+=String.fromCharCode(e.charCodeAt(t)&255);n(i)},r,"text/plain; charset=x-user-defined")};var n=function(e){var t=/^"(.+)*"$/,n=/^'(.+)*'$/;return t.test(e)?e.replace(t,"$1"):n.test(e)?e.replace(n,"$1"):e};e.util.extractCssUrl=function(e){var t=/^url\(([^\)]+)\)/,r;if(!t.test(e))throw new Error("Invalid url");return r=t.exec(e)[1],n(r)};var r=function(e){var t=window.document.createElement("canvas"),n=t.getContext("2d");return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),t.toDataURL("image/png")};e.util.getDataURIForImageURL=function(e,t,n){var i=new window.Image,s;i.onload=function(){try{s=r(i)}catch(e){n();return}t(s)},n&&(i.onerror=n),i.src=e};var i=function(t,n){return n&&n!=="about:blank"&&(t=e.util.joinUrl(n,t)),t},s=function(e){var t=new CSSParser,n=t.parse(e,!1,!0);return n},o=function(e){var t=[],n,r,i;if(!e)return[];for(n=0;n<e.cssRules.length;n++){i=e.cssRules[n];if(i.type===window.kJscsspSTYLE_RULE)for(r=0;r<i.declarations.length;r++)i.declarations[r].property==="background-image"&&t.push(i.declarations[r])}return t},u=function(e){var t=[],n,r,i;for(n=0;n<e.cssRules.length;n++){i=e.cssRules[n];if(i.type===window.kJscsspFONT_FACE_RULE)for(r=0;r<i.descriptors.length;r++)i.descriptors[r].property==="src"&&t.push(i.descriptors[r])}return t},a=function(e,t){var n={baseUrl:null,callback:null};return typeof t=="undefined"&&typeof e=="function"?n.callback=e:(typeof e!="undefined"&&(n.baseUrl=e),typeof t!="undefined"&&(n.callback=t)),n},f=function(t,n,r,s){var o=t.attributes.src.nodeValue,u=n||t.ownerDocument.baseURI;e.util.isDataUri(o)&&r(),o=i(o,u),e.util.getDataURIForImageURL(o,function(e){t.attributes.src.nodeValue=e,r()},function(){s(o)})};e.loadAndInlineImages=function(t,n,r){var i=a(n,r),s=t.getElementsByTagName("img"),o=[];e.util.map(s,function(e,t){f(e,i.baseUrl,t,function(e){o.push({resourceType:"image",url:e}),t()})},function(){i.callback&&i.callback(o)})};var l=function(t,n){var r;try{r=e.util.extractCssUrl(n.values[0].cssText())}catch(i){return!1}return e.util.isDataUri(r)?!1:(r=e.util.joinUrl(t,r),n.values[0].setCssText('url("'+r+'")'),!0)},c=function(e,t){var n=s(t),r=o(n),i=!1,u;for(u=0;u<r.length;u++)i=l(e,r[u])||i;return i?n.cssText():t},h=function(e,t){var n=e.createElement("style"),r=e.getElementsByTagName("head")[0];n.type="text/css",n.appendChild(e.createTextNode(t)),r.appendChild(n)},p=function(t,n,r,s){var o=t.attributes.href.nodeValue,u=n||t.ownerDocument.baseURI,a=i(o,u),f;e.util.ajax(a,function(e){f=c(o,e),t.parentNode.removeChild(t),r(f)},function(){s(a)})},d=function(e,t){var n=t.join("").trim();n&&h(e,n)};e.loadAndInlineCSS=function(t,n,r){var i=a(n,r),s=t.getElementsByTagName("link"),o=[];e.util.map(s,function(e,t){e.attributes.rel&&e.attributes.rel.nodeValue==="stylesheet"&&(!e.attributes.type||e.attributes.type.nodeValue==="text/css")?p(e,i.baseUrl,function(e){e.trim()?t(e+"\n"):t("")},function(e){o.push({resourceType:"stylesheet",url:e}),t("")}):t("")},function(e){d(t,e),i.callback&&i.callback(o)})};var v=function(t,n,r,s){var o;try{o=e.util.extractCssUrl(t.values[0].cssText())}catch(u){r(!1);return}if(e.util.isDataUri(o)){r(!1);return}o=i(o,n),e.util.getDataURIForImageURL(o,function(e){t.values[0].setCssText('url("'+e+'")'),r(!0)},function(){s(o)})},m=function(e,t,n){var r=o(e),i=[],s;rasterizeHTML.util.map(r,function(e,n){v(e,t,n,function(e){i.push({resourceType:"backgroundImage",url:e}),n()})},function(e){s=e.indexOf(!0)>=0,n(s,i)})},g=function(t,n,r,s){var o,u;try{o=e.util.extractCssUrl(t.values[0].cssText())}catch(a){r(!1);return}if(e.util.isDataUri(o)){r(!1);return}o=i(o,n),e.util.binaryAjax(o,function(e){u=btoa(e),t.values[0].setCssText('url("data:font/woff;base64,'+u+'")'),r(!0)},function(){s(o)})},y=function(e,t,n){var r=u(e),i=[],s;rasterizeHTML.util.map(r,function(e,n){g(e,t,n,function(e){i.push({resourceType:"fontFace",url:e}),n()})},function(e){s=e.indexOf(!0)>=0,n(s,i)})},b=function(e,t){var n=o(t).length>0;return n&&window.navigator.userAgent.indexOf("WebKit")>=0?"span {}\n"+e:e},w=function(e,t,n){var r=e.textContent,i=t||e.ownerDocument.baseURI,o=s(r);m(o,i,function(t,s){y(o,i,function(i,u){if(t||i)r=o.cssText();r=b(r,o),e.childNodes[0].nodeValue=r,n(s.concat(u))})})};e.loadAndInlineCSSReferences=function(t,n,r){var i=a(n,r),s=[],o=t.getElementsByTagName("style");e.util.map(o,function(e,t){e.attributes.type&&e.attributes.type.nodeValue==="text/css"?w(e,i.baseUrl,function(e){s=s.concat(e),t()}):t()},function(){i.callback&&i.callback(s)})};var E=function(){return window.navigator.userAgent.indexOf("WebKit")>=0},S=function(t){var n;return t.documentElement.setAttribute("xmlns",t.documentElement.namespaceURI),n=(new window.XMLSerializer).serializeToString(t.documentElement),E()?window.HTMLtoXML?window.HTMLtoXML(n):(e.util.log("Looks like your browser needs htmlparser.js as workaround for writing XML. Please include it."),n):n},x=function(){if(window.navigator.userAgent.indexOf("WebKit")>=0&&window.navigator.userAgent.indexOf("Chrome")<0)return!1;if(window.BlobBuilder||window.MozBlobBuilder||window.WebKitBlobBuilder)return!0;if(window.Blob)try{return new window.Blob("<b></b>",{type:"text/xml"}),!0}catch(e){return!1}return!1},T=function(e){var t="image/svg+xml;charset=utf-8",n=window.BlobBuilder||window.MozBlobBuilder||window.WebKitBlobBuilder,r;return n?(r=new n,r.append(e),r.getBlob(t)):new window.Blob(e,{type:t})},N=function(e){var t=window.URL||window.webkitURL||window;return x()?t.createObjectURL(T(e)):"data:image/svg+xml;charset=utf-8,"+e},C=function(e){var t=window.URL||window.webkitURL||window;x()&&t.revokeObjectURL(e)},k=function(e,t){var n=e.getElementById(t);return n||(n=e.createElement("div"),n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.style.position="absolute",n.style.top="-10000px",n.style.left="-10000px",n.id=t,e.getElementsByTagName("body")[0].appendChild(n)),n},L="rasterizeHTML_js_FirefoxWorkaround",A=function(t,n){var r=e.util.getConstantUniqueIdFor(t),i=k(t.ownerDocument,L+r);i.innerHTML=n,i.className=L},O=function(t){var n=e.util.getConstantUniqueIdFor(t),r=t.ownerDocument.getElementById(L+n);r&&t.ownerDocument.getElementsByTagName("body")[0].removeChild(r)};return e.getSvgForDocument=function(e,t,n){var r=S(e),i=t||100,s=n||100;return'<svg xmlns="http://www.w3.org/2000/svg" width="'+i+'" height="'+s+'">'+'<foreignObject width="100%" height="100%">'+r+"</foreignObject>"+"</svg>"},e.drawSvgToCanvas=function(e,t,n,r){var i,s,o,u,a=function(){o&&C(o),O(t)};A(t,e),i=t.getContext("2d"),o=N(e),u=new window.Image,u.onload=function(){try{i.drawImage(u,0,0)}catch(e){r();return}finally{a()}n&&n(t)},u.onerror=function(){a(),r()},u.src=o},e.drawDocument=function(t,n,r,i){var s=a(r,i),o=[],u;e.loadAndInlineImages(t,s.baseUrl,function(r){o=o.concat(r),e.loadAndInlineCSS(t,s.baseUrl,function(r){o=o.concat(r),e.loadAndInlineCSSReferences(t,s.baseUrl,function(r){o=o.concat(r),u=e.getSvgForDocument(t,n.width,n.height),e.drawSvgToCanvas(u,n,function(){s.callback&&s.callback(n,o)},function(){o.push({resourceType:"document"}),s.callback&&s.callback(n,o)})})})})},e.drawHTML=function(t,n,r,i){var s=a(r,i),o=window.document.implementation.createHTMLDocument("");o.documentElement.innerHTML=t,e.drawDocument(o,n,s.baseUrl,s.callback)},e.drawURL=function(t,n,r){e.util.ajax(t,function(i){e.drawHTML(i,n,t,r)},function(){r&&r(n,[{resourceType:"page",url:t}])})},e}();