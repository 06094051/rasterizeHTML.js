/*! rasterizeHTML.js - v0.8.0 - 2014-04-18
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2014 Christoph Burgmer; Licensed MIT */
!function(a,b){"object"==typeof exports?module.exports=b(require("url"),require("xmlserializer"),require("ayepromise"),require("inlineresources")):"function"==typeof define&&define.amd?define(["url","xmlserializer","ayepromise","inlineresources"],b):a.rasterizeHTML=b(a.url,a.xmlserializer,a.ayepromise,a.inlineresources)}(this,function(a,b,c,d){var e=function(a){var b={};return b.baseUrlRespecting=function(a,b){var c=function(){var c=new a,d=c.open;return c.open=function(){var a=Array.prototype.slice.call(arguments),c=a.shift(),e=a.shift(),g=f.joinUrl(b,e);return d.apply(this,[c,g].concat(a))},c};return c},b.finishNotifying=function(b){var c=0,d=0,e=!1,f=a.defer(),g=function(){var a=c-d;0>=a&&e&&f.resolve({totalCount:c})},h=function(){var a=new b,e=a.send;return a.send=function(){return c+=1,e.apply(this,arguments)},a.addEventListener("load",function(){d+=1,g()}),a};return h.waitForRequestsToFinish=function(){return e=!0,g(),f.promise},h},b}(c),f=function(a,b,c,d){"use strict";var e={},g=[];e={},e.joinUrl=function(a,b){return c.resolve(a,b)},e.getConstantUniqueIdFor=function(a){return g.indexOf(a)<0&&g.push(a),g.indexOf(a)},e.clone=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};var h=function(a){return"object"==typeof a&&null!==a},i=function(a){return h(a)&&Object.prototype.toString.apply(a).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},j=function(a){return"function"==typeof a};e.parseOptionalParameters=function(a){var b={canvas:null,options:{},callback:null};return j(a[0])?b.callback=a[0]:null==a[0]||i(a[0])?(b.canvas=a[0]||null,j(a[1])?b.callback=a[1]:(b.options=e.clone(a[1]),b.callback=a[2]||null)):(b.options=e.clone(a[0]),b.callback=a[1]||null),b};var k=function(a,b){var c=a.createElement(b);return c.style.visibility="hidden",c.style.width="0px",c.style.height="0px",c.style.position="absolute",c.style.top="-10000px",c.style.left="-10000px",a.getElementsByTagName("body")[0].appendChild(c),c};e.executeJavascript=function(c,e,f){var g=k(d.document,"iframe"),h=c.documentElement.outerHTML,i=[],j=b.defer(),l=function(){var a=g.contentDocument;d.document.getElementsByTagName("body")[0].removeChild(g),j.resolve({document:a,errors:i})};g.onload=f>0?function(){setTimeout(l,f)}:l;var m=g.contentWindow.XMLHttpRequest,n=a.baseUrlRespecting(m,e);return g.contentDocument.open(),g.contentWindow.XMLHttpRequest=n,g.contentWindow.onerror=function(a){i.push({resourceType:"scriptExecution",msg:a})},g.contentDocument.write(h),g.contentDocument.close(),j.promise};var l=function(a,b,c){var d=a.createElement("iframe");return d.style.width=b+"px",d.style.height=c+"px",d.style.visibility="hidden",d.style.position="absolute",d.style.top=-1e4-c+"px",d.style.left=-1e4-b+"px",d.sandbox="allow-same-origin",a.getElementsByTagName("body")[0].appendChild(d),d};e.calculateDocumentContentSize=function(a,c,e){var f=a.documentElement.outerHTML,g=l(d.document,c,e),h=b.defer();return g.onload=function(){var a=g.contentDocument,b=Math.max(a.documentElement.scrollWidth,a.body.clientWidth),c=Math.max(a.documentElement.scrollHeight,a.body.scrollHeight,a.body.clientHeight);d.document.getElementsByTagName("body")[0].removeChild(g),h.resolve({width:b,height:c})},g.contentDocument.open(),g.contentDocument.write(f),g.contentDocument.close(),h.promise};var m=function(a,b){var c,e,f,g,h=/<html((?:\s+[^>]*)?)>/im.exec(b),i=d.document.implementation.createHTMLDocument("");if(h)for(c="<div"+h[1]+"></div>",i.documentElement.innerHTML=c,f=i.querySelector("div"),e=0;e<f.attributes.length;e++)g=f.attributes[e],a.documentElement.setAttribute(g.name,g.value)};e.parseHTML=function(a){var b;return(new DOMParser).parseFromString("<a></a>","text/html")?b=(new DOMParser).parseFromString(a,"text/html"):(b=d.document.implementation.createHTMLDocument(""),b.documentElement.innerHTML=a,m(b,a)),b};var n=function(a){var b=new DOMParser,c=b.parseFromString("<","text/xml"),d=c.getElementsByTagName("parsererror")[0].namespaceURI;return"http://www.w3.org/1999/xhtml"===d?a.getElementsByTagName("parsererror").length>0:a.getElementsByTagNameNS(d,"parsererror").length>0},o=function(a){if(n(a))throw{message:"Invalid source"}};e.validateXHTML=function(a){var b=new DOMParser,c=b.parseFromString(a,"application/xml");o(c)};var p=null,q=function(a,b){return b===!1||"none"===b||"repeated"===b?((null===p||"repeated"!==b)&&(p=Date.now()),a+"?_="+p):a},r=function(a,c){var d=new window.XMLHttpRequest,e=f.joinUrl(c.baseUrl,a),g=q(e,c.cache),h=b.defer(),i=function(){h.reject({message:"Unable to load page"})};d.addEventListener("load",function(){200===d.status||0===d.status?h.resolve(d.responseXML):i()},!1),d.addEventListener("error",function(){i()},!1);try{d.open("GET",g,!0),d.responseType="document",d.send(null)}catch(j){i()}return h.promise};e.loadDocument=function(a,b){return r(a,b).then(function(a){return o(a),a})},e.addClassNameRecursively=function(a,b){a.className+=" "+b,a.parentNode!==a.ownerDocument&&e.addClassNameRecursively(a.parentNode,b)};var s=function(a,b){var c=a.parentStyleSheet,d=Array.prototype.indexOf.call(c.cssRules,a);c.insertRule(b,d+1),c.deleteRule(d)},t=function(a,b){var c=a.cssText.replace(/^[^\{]+/,""),d=b+" "+c;s(a,d)},u=function(a){return Array.prototype.reduce.call(a,function(a,b){return a+b.cssText},"")},v=function(a){a.textContent=u(a.sheet.cssRules)};return e.rewriteStyleRuleSelector=function(a,b,c){var d=b+"(?=\\W|$)";Array.prototype.forEach.call(a.querySelectorAll("style"),function(a){var b=Array.prototype.filter.call(a.sheet.cssRules,function(a){return a.selectorText&&new RegExp(d).test(a.selectorText)});b.length&&(b.forEach(function(a){var b=a.selectorText.replace(new RegExp(d,"g"),c);t(a,b)}),v(a))})},e.fakeHover=function(a,b){var c=a.querySelector(b),d="rasterizehtmlhover";c&&(e.addClassNameRecursively(c,d),e.rewriteStyleRuleSelector(a,":hover","."+d))},e.fakeActive=function(a,b){var c=a.querySelector(b),d="rasterizehtmlactive";c&&(e.addClassNameRecursively(c,d),e.rewriteStyleRuleSelector(a,":active","."+d))},e.persistInputValues=function(a){var b=Array.prototype.slice.call(a.querySelectorAll("input")),c=Array.prototype.slice.call(a.querySelectorAll("textarea")),d=function(a){return"checkbox"===a.type||"radio"===a.type};b.filter(d).forEach(function(a){a.checked?a.setAttribute("checked",""):a.removeAttribute("checked")}),b.filter(function(a){return!d(a)}).forEach(function(a){a.setAttribute("value",a.value)}),c.forEach(function(a){a.textContent=a.value})},e}(e,c,a,window),g=function(a,b,c,d){"use strict";var e={},f=function(){if(d.navigator.userAgent.indexOf("WebKit")>=0&&d.navigator.userAgent.indexOf("Chrome")<0)return!1;if(d.BlobBuilder||d.MozBlobBuilder||d.WebKitBlobBuilder)return!0;if(d.Blob)try{return new d.Blob(["<b></b>"],{type:"text/xml"}),!0}catch(a){return!1}return!1},g=function(a){var b,c="image/svg+xml;charset=utf-8",e=d.BlobBuilder||d.MozBlobBuilder||d.WebKitBlobBuilder;return e?(b=new e,b.append(a),b.getBlob(c)):new d.Blob([a],{type:c})},h=function(a){var b=d.URL||d.webkitURL||d;return f()?b.createObjectURL(g(a)):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},i=function(a){var b=d.URL||d.webkitURL||d;f()&&b.revokeObjectURL(a)},j=function(a,b){var c=a.createElement(b);return c.style.visibility="hidden",c.style.width="0px",c.style.height="0px",c.style.position="absolute",c.style.top="-10000px",c.style.left="-10000px",a.getElementsByTagName("body")[0].appendChild(c),c},k=function(a,b){var c=a.getElementById(b);return c||(c=j(a,"div"),c.id=b),c},l="rasterizeHTML_js_FirefoxWorkaround",m=function(){var a=d.navigator.userAgent.match(/Firefox\/(\d+).0/);return!a||!a[1]||parseInt(a[1],10)<17},n=function(b,c){var e,f=a.getConstantUniqueIdFor(b),g=c?c.ownerDocument:d.document;m()&&(e=k(g,l+f),e.innerHTML=b,e.className=l)},o=function(a){d.navigator.userAgent.indexOf("WebKit")>=0&&Array.prototype.forEach.call(a.getElementsByTagName("style"),function(a){a.textContent="span {}\n"+a.textContent})},p=function(b,c){var e=a.getConstantUniqueIdFor(b),f=c?c.ownerDocument:d.document,g=f.getElementById(l+e);g&&g.parentNode.removeChild(g)},q=function(a,b,c){var d,e,f="";return c=c||1,d=Math.round(a/c),e=Math.round(b/c),1!==c&&(f=' style="-webkit-transform: scale('+c+"); -webkit-transform-origin: top left; transform: scale("+c+'); transform-origin: top left;"'),' width="'+d+'" height="'+e+'"'+f};e.getSvgForDocument=function(c,d,e,f){var g;return o(c),g=b.serializeToString(c),a.validateXHTML(g),'<svg xmlns="http://www.w3.org/2000/svg" width="'+d+'" height="'+e+'"><foreignObject'+q(d,e,f)+">"+g+"</foreignObject></svg>"};var r=function(){return{message:"Error rendering page"}};e.renderSvg=function(a,b){var e,f,g=c.defer(),j=function(){f.onload=null,f.onerror=null},k=function(){e&&i(e),p(a,b)};return n(a,b),e=h(a),f=new d.Image,f.onload=function(){j(),k(),g.resolve(f)},f.onerror=function(){k(),g.reject(r())},f.src=e,g.promise},e.drawImageOnCanvas=function(a,b){try{b.getContext("2d").drawImage(a,0,0)}catch(c){throw r()}};var s=function(a,b){var c=300,d=200,e=a?a.width:c,f=a?a.height:d,g=void 0!==b.width?b.width:e,h=void 0!==b.height?b.height:f;return{width:g,height:h}};return e.drawDocumentImage=function(b,c,d){var f=s(c,d);return d.hover&&a.fakeHover(b,d.hover),d.active&&a.fakeActive(b,d.active),a.calculateDocumentContentSize(b,f.width,f.height).then(function(a){return e.getSvgForDocument(b,a.width,a.height,d.zoom)}).then(function(a){return e.renderSvg(a,c)})},e}(f,b,c,window),h=function(a,b,c){"use strict";var d={},e=function(a,c,d){return b.drawDocumentImage(a,c,d).then(function(a){return c&&b.drawImageOnCanvas(a,c),a})},f=function(b,d,f){var g,h=f.executeJsTimeout||0;return g=a.clone(f),g.inlineScripts=f.executeJs===!0,c.inlineReferences(b,g).then(function(c){return f.executeJs?a.executeJavascript(b,f.baseUrl,h).then(function(b){var d=b.document;return a.persistInputValues(d),{document:d,errors:c.concat(b.errors)}}):{document:b,errors:c}}).then(function(a){return e(a.document,d,f).then(function(b){return{image:b,errors:a.errors}})})};d.drawDocument=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c),e=f(b,d.canvas,d.options);return d.callback&&e.then(function(a){d.callback(a.image,a.errors)},function(){d.callback(null,[{resourceType:"document",msg:"Error rendering page"}])}),e};var g=function(b,c,e,f){var g=a.parseHTML(b);return d.drawDocument(g,c,e,f)};d.drawHTML=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return g(b,d.canvas,d.options,d.callback)};var h=function(b,c,e,f){var g=a.loadDocument(b,e).then(function(a){return d.drawDocument(a,c,e)});return f&&g.then(function(a){f(a.image,a.errors)},function(a){f(null,[{resourceType:"page",url:b,msg:a.message+" "+b}])}),g};return d.drawURL=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return h(b,d.canvas,d.options,d.callback)},d}(f,g,d);return h});