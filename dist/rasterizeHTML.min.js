/*! rasterizeHTML.js - v0.3.0 - 2013-03-09
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2013 Christoph Burgmer; Licensed MIT */
window.rasterizeHTMLInline=function(e,t,n,r){"use strict";var i={};i.util={},i.util.cloneArray=function(e){return Array.prototype.slice.apply(e,[0])},i.util.joinUrl=function(e,n){var r=new t(n);return r.is("relative")&&(r=r.absoluteTo(e)),r.toString()},i.util.isDataUri=function(e){return/^data:/.test(e)},i.util.map=function(e,t,n){var r=0,s=i.util.cloneArray(e),o=[],u;s.length===0&&n(o);var a=function(e){function i(t){r+=1,o[e]=t,r===s.length&&n(o)}t(s[e],i)};for(u=0;u<s.length;u++)a(u)};var s=function(e){return e+"?_="+Date.now()};i.util.ajax=function(t,n,r,i){var o=new e.XMLHttpRequest,u;n=n||{},u=n.cache===!1?s(t):t,o.addEventListener("load",function(){o.status===200||o.status===0?r(o.response):i()},!1),o.addEventListener("error",function(){i()},!1),o.open("GET",u,!0),o.overrideMimeType(n.mimeType);try{o.send(null)}catch(a){i()}},i.util.binaryAjax=function(e,t,n,r){var s="";t=t||{},i.util.ajax(e,{mimeType:"text/plain; charset=x-user-defined",cache:t.cache},function(e){for(var t=0;t<e.length;t++)s+=String.fromCharCode(e.charCodeAt(t)&255);n(s)},r)};var o=function(e){var t=/^"(.*)"$/,n=/^'(.*)'$/;return t.test(e)?e.replace(t,"$1"):n.test(e)?e.replace(n,"$1"):e},u=function(e){var t=/^[\t\r\f\n ]*(.+?)[\t\r\f\n ]*$/;return e.replace(t,"$1")};i.util.extractCssUrl=function(e){var t=/^url\(([^\)]+)\)/,n;if(!t.test(e))throw new Error("Invalid url");return n=t.exec(e)[1],o(u(n))};var a=function(e){var t=function(e,t){return e.substring(0,t.length)===t};return t(e,"<?xml")||t(e,"<svg")?"image/svg+xml":"image/png"};i.util.getDataURIForImageURL=function(e,t,n,r){var s,o;i.util.binaryAjax(e,t,function(e){s=btoa(e),o=a(e),n("data:"+o+";base64,"+s)},function(){r()})};var f=function(e,t){return t&&t!=="about:blank"&&(e=i.util.joinUrl(t,e)),e},l=function(e){return Array.prototype.slice.call(e)},c=function(e){var t=document.implementation.createHTMLDocument(""),n=document.createElement("style"),r;return n.textContent=e,t.body.appendChild(n),r=n.sheet.cssRules,t.body.removeChild(n),l(r)},h=function(t){return e.navigator.userAgent.indexOf("Chrome")>=0?r.parse(t).cssRules:c(t)},p=function(e){var t=new n,r=t.parse(e,!1,!0);return r},d=function(t){var n=[];return t.forEach(function(t){t.type===e.CSSRule.STYLE_RULE&&t.style.getPropertyValue("background-image")&&n.push(t)}),n},v=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspSTYLE_RULE)for(i=0;i<s.declarations.length;i++)(s.declarations[i].property==="background-image"||s.declarations[i].property==="background")&&n.push(s.declarations[i])}return n},m=function(t){var n=[];return t.forEach(function(t){t.type===e.CSSRule.FONT_FACE_RULE&&t.style.getPropertyValue("src")&&n.push(t)}),n},g=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspFONT_FACE_RULE)for(i=0;i<s.descriptors.length;i++)s.descriptors[i].property==="src"&&n.push(s.descriptors[i])}return n},y=function(e){var t="";return e.forEach(function(e){t+=e.cssText}),t},b=function(t){var n="",r;return t.cssRules.forEach(function(t){if(t.type===e.kJscsspSTYLE_RULE){n+=t.selectorText()+" {\n";for(r=0;r<t.declarations.length;r++)n+=t.declarations[r].property+": "+t.declarations[r].valueText+";\n";n+="}\n"}else t.type===e.kJscsspFONT_FACE_RULE?(n+="@font-face {\n",t.descriptors.forEach(function(e){n+="  "+e.property+": "+e.valueText+";\n"}),n+="}\n"):n+=t.cssText()+"\n"}),n},w=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},E=function(e){return typeof e=="function"};i.util.parseOptionalParameters=function(){var e={options:{},callback:null};return E(arguments[0])?e.callback=arguments[0]:(e.options=w(arguments[0]),e.callback=arguments[1]||null),e};var S=function(e,t,n,r,s){var o=e.attributes.src.nodeValue,u=t||e.ownerDocument.baseURI;if(i.util.isDataUri(o)){r();return}o=f(o,u),i.util.getDataURIForImageURL(o,{cache:n},function(t){e.attributes.src.nodeValue=t,r()},function(){s(o)})},x=function(e){var t=[];return Array.prototype.forEach.call(e,function(e){e.type==="image"&&t.push(e)}),t};i.loadAndInlineImages=function(e,t,n){var r=i.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("img"),o=e.getElementsByTagName("input"),u=r.options.baseUrl,a=r.options.cache!==!1,f=[],l=[];f=Array.prototype.slice.call(s),f=f.concat(x(o)),i.util.map(f,function(e,t){S(e,u,a,t,function(e){l.push({resourceType:"image",url:e,msg:"Unable to load image "+e}),t()})},function(){r.callback&&r.callback(l)})};var T=function(e,t,n){var r=e.indexOf(t),i="@font-face { font-family: "+t.style.getPropertyValue("font-family")+"; src: "+n+"}",s=t.parentStyleSheet;s.insertRule(i,r+1),s.deleteRule(r),e[r]=s.cssRules[r]},N=function(e,t){var n=h(t),r=!1;return d(n).forEach(function(t){var n=P(t.style.getPropertyValue("background-image")),s=!1;n.forEach(function(t){var n=H(t),r;n&&!i.util.isDataUri(n.url)&&(r=i.util.joinUrl(e,n.url),t[n.idx]='url("'+r+'")',s=!0)}),t.style.setProperty("background-image",B(n)),r=r||s}),m(n).forEach(function(t){var s=q(t.style.getPropertyValue("src")),o=!1;s.forEach(function(t){var n=U(t),r;n&&!i.util.isDataUri(n.url)&&(r=i.util.joinUrl(e,n.url),t[0]='url("'+r+'")',o=!0)}),o&&T(n,t,R(s)),r=r||o}),r?y(n):t},C=function(e,t){var n=e.parentNode,r;t=t.trim(),t&&(r=e.ownerDocument.createElement("style"),r.type="text/css",r.appendChild(e.ownerDocument.createTextNode(t)),n.insertBefore(r,e)),n.removeChild(e)},k=function(e,t,n,r,s){var o=e.attributes.href.nodeValue,u=t||e.ownerDocument.baseURI,a=f(o,u),l;i.util.ajax(a,{cache:n},function(e){l=N(o,e),r(l)},function(){s(a)})};i.loadAndInlineCSS=function(e,t,n){var r=i.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("link"),o=r.options.baseUrl,u=r.options.cache!==!1,a=[];i.util.map(s,function(e,t){e.attributes.rel&&e.attributes.rel.nodeValue==="stylesheet"&&(!e.attributes.type||e.attributes.type.nodeValue==="text/css")?k(e,o,u,function(n){C(e,n+"\n"),t()},function(e){a.push({resourceType:"stylesheet",url:e,msg:"Unable to load stylesheet "+e}),t()}):t()},function(){r.callback&&r.callback(a)})};var L=function(t){var n=[];return t.forEach(function(t){t.type===e.CSSRule.IMPORT_RULE&&t.href&&n.push(t)}),n},A=function(e,t,n,r){var i=N(n,r),s=h(i),o=e.indexOf(t);e.splice(o,1),s.forEach(function(t,n){e.splice(o+n,0,t)})},O=function(e){var t=/^"(.*)"$/,n=/^'(.*)'$/;return t.test(e)||n.test(e)},M=function(e,t,n,r,s,u,a){var l=t.href,c;O(l)&&(l=o(l)),c=f(l,n);if(s.indexOf(c)>=0){A(e,t,l,""),u([]);return}s.push(c),i.util.ajax(c,{cache:r},function(i){_(i,n,r,s,function(n,r){A(e,t,l,n),u(r)})},function(){a(c)})},_=function(e,t,n,r,s){var o=h(e),u=[],a;a=L(o);if(a.length===0){s(e,u);return}i.util.map(a,function(e,i){M(o,e,t,n,r,function(e){u=u.concat(e),i()},function(e){u.push({resourceType:"stylesheet",url:e,msg:"Unable to load stylesheet "+e}),i()})},function(){e=y(o),s(e,u)})},D=function(e,t,n,r,i){_(e.textContent,t,n,r,function(t,n){e.textContent!==t&&(e.childNodes[0].nodeValue=t),i(n)})};i.loadAndInlineCSSImports=function(e,t,n){var r=i.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("style"),o=r.options.baseUrl||e.baseURI,u=r.options.cache!==!1,a=[],f=[];i.util.map(s,function(e,t){!e.attributes.type||e.attributes.type.nodeValue==="text/css"?D(e,o,u,f,function(e){a=a.concat(e),t()}):t()},function(){r.callback(a)})};var P=function(e){var t="\\s*(?:\"[^\"]*\"|'[^']*'|[^\\(]+)\\s*",n="(url\\("+t+"\\)"+"|"+"[^,\\s]+"+")",r="(?:\\s*"+n+")+",i="^\\s*("+r+")"+"(?:\\s*,\\s*("+r+"))*"+"\\s*$",s=new RegExp(r,"g"),o,u=[],a=function(e){var t=new RegExp(n,"g"),r=[],i;i=t.exec(e);while(i)r.push(i[1]),i=t.exec(e);return r};if(e.match(new RegExp(i))){o=s.exec(e);while(o)u.push(a(o[0])),o=s.exec(e);return u}return[]},H=function(e){var t,n;for(t=0;t<e.length;t++)try{return n=i.util.extractCssUrl(e[t]),{url:n,idx:t}}catch(r){}},B=function(e){var t=[];return e.forEach(function(e){t.push(e.join(" "))}),t.join(", ")},j=function(e,t,n,r){var s=[],o;o=P(e.valueText),i.util.map(o,function(e,r){var o=H(e),u;if(!o||i.util.isDataUri(o.url)){r(!1);return}u=f(o.url,t),i.util.getDataURIForImageURL(u,{cache:n},function(t){e[o.idx]='url("'+t+'")',r(!0)},function(){s.push(u),r(!1)})},function(t){var n=t.indexOf(!0)>=0;n&&(e.valueText=B(o)),r(n,s)})},F=function(e,t,n,r){var s=v(e),o=[],u;i.util.map(s,function(e,r){j(e,t,n,function(e,t){t.forEach(function(e){o.push({resourceType:"backgroundImage",url:e,msg:"Unable to load background-image "+e})}),r(e)})},function(e){u=e.indexOf(!0)>=0,r(u,o)})},I=function(e){var t=/^format\(([^\)]+)\)/,n;return t.test(e)?(n=t.exec(e)[1],o(n)):null},q=function(e){var t="\\s*(?:\"[^\"]*\"|'[^']*'|[^\\(]+)\\s*",n="(local\\("+t+"\\))"+"|"+"(url\\("+t+"\\))"+"(?:\\s+(format\\("+t+"\\)))?",r="^\\s*("+n+")"+"(?:\\s*,\\s*("+n+"))*"+"\\s*$",i=new RegExp(n,"g"),s,o=[],u=function(e){var t=[];return e.slice(1).forEach(function(e){e&&t.push(e)}),t};if(e.match(new RegExp(r))){s=i.exec(e);while(s)o.push(u(s)),s=i.exec(e);return o}return[]},R=function(e){var t=[];return e.forEach(function(e){t.push(e.join(" "))}),t.join(", ")},U=function(e){var t,n=null;try{return t=i.util.extractCssUrl(e[0]),e[1]&&(n=I(e[1])),{url:t,format:n}}catch(r){}},z=function(e,t,n,r){var s,o,u,a,l,c=[];s=q(e.valueText),i.util.map(s,function(e,r){o=U(e);if(!o||i.util.isDataUri(o.url)){r(!1);return}u=f(o.url,t),a=o.format||"woff",i.util.binaryAjax(u,{cache:n},function(t){l=btoa(t),e[0]='url("data:font/'+a+";base64,"+l+'")',r(!0)},function(){c.push(u),r(!1)})},function(t){var n=t.indexOf(!0)>=0;n&&(e.valueText=R(s)),r(n,c)})},W=function(e,t,n,r){var s=g(e),o=[],u;i.util.map(s,function(e,r){z(e,t,n,function(e,t){t.forEach(function(e){o.push({resourceType:"fontFace",url:e,msg:"Unable to load font-face "+e})}),r(e)})},function(e){u=e.indexOf(!0)>=0,r(u,o)})},X=function(t,n){var r=v(n).length+g(n).length>0;return r&&e.navigator.userAgent.indexOf("WebKit")>=0?"span {}\n"+t:t},V=function(e,t,n,r){var i=e.textContent,s=t||e.ownerDocument.baseURI,o=p(i);F(o,s,n,function(t,u){W(o,s,n,function(n,s){if(t||n)i=b(o);i=X(i,o),e.childNodes[0].nodeValue=i,r(u.concat(s))})})};i.loadAndInlineCSSReferences=function(e,t,n){var r=i.util.parseOptionalParameters(t,n),s=[],o=r.options.baseUrl,u=r.options.cache!==!1,a=e.getElementsByTagName("style");i.util.map(a,function(e,t){!e.attributes.type||e.attributes.type.nodeValue==="text/css"?V(e,o,u,function(e){s=s.concat(e),t()}):t()},function(){r.callback&&r.callback(s)})};var $=function(e,t,n,r,s){var o=t||e.ownerDocument.baseURI,u=f(e.attributes.src.nodeValue,o);i.util.ajax(u,{cache:n},r,function(){s(u)})},J=function(e,t){var n=e.ownerDocument.createElement("script"),r=e.parentNode;e.attributes.type&&(n.type=e.attributes.type.nodeValue),n.appendChild(e.ownerDocument.createTextNode(t)),r.insertBefore(n,e),r.removeChild(e)};return i.loadAndInlineScript=function(e,t,n){var r=i.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("script"),o=r.options.cache!==!1,u=[];i.util.map(s,function(e,t){e.attributes.src?$(e,r.options.baseUrl,o,function(n){J(e,n),t()},function(e){u.push({resourceType:"script",url:e,msg:"Unable to load script "+e}),t()}):t()},function(){r.callback&&r.callback(u)})},i.inlineReferences=function(e,t,n){var r=[];i.loadAndInlineImages(e,t,function(s){r=r.concat(s),i.loadAndInlineCSS(e,t,function(s){r=r.concat(s),i.loadAndInlineCSSImports(e,t,function(s){r=r.concat(s),i.loadAndInlineCSSReferences(e,t,function(s){r=r.concat(s),i.loadAndInlineScript(e,t,function(e){r=r.concat(e),n(r)})})})})})},i}(window,URI,CSSParser,window.CSSOM||{}),window.rasterizeHTML=function(e,t,n){"use strict";var r={},i=[];r.util={},r.util.getConstantUniqueIdFor=function(e){return i.indexOf(e)<0&&i.push(e),i.indexOf(e)},r.util.log=function(e){n.console&&n.console.log&&n.console.log(e)};var s=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},o=function(e){return typeof e=="object"&&e!==null},u=function(e){return o(e)&&Object.prototype.toString.apply(e).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},a=function(e){return typeof e=="function"};r.util.parseOptionalParameters=function(){var e={canvas:null,options:{},callback:null};return a(arguments[0])?e.callback=arguments[0]:arguments[0]==null||u(arguments[0])?(e.canvas=arguments[0]||null,a(arguments[1])?e.callback=arguments[1]:(e.options=s(arguments[1]),e.callback=arguments[2]||null)):(e.options=s(arguments[0]),e.callback=arguments[1]||null),e};var f=function(e){return(""+function(e){window.parent.rasterizeHTML.util.reportIframeJsError("put_unique_id_here",e)}).replace("put_unique_id_here",e)},l={};r.util.reportIframeJsError=function(e,t){var n=l[e]||[];n.push(t),l[e]=n};var c=function(e){var t=[];return l[e]&&l[e].forEach(function(e){t.push({resourceType:"scriptExecution",msg:e})}),t};r.util.executeJavascript=function(e,t,i){var s=y(n.document,"iframe"),o=e.getElementsByTagName("html")[0].innerHTML,u=r.util.getConstantUniqueIdFor(e),a="<script>window.onerror = "+f(u)+";</script>",l=function(){var e=s.contentDocument;n.document.getElementsByTagName("body")[0].removeChild(s),i(e,c(u))};t>0?s.onload=function(){setTimeout(l,t)}:s.onload=l,s.contentDocument.open(),s.contentDocument.write("<html>"+a+o+"</html>"),s.contentDocument.close()};var h=function(){return n.navigator.userAgent.indexOf("WebKit")>=0},p=function(e){var i;return e.documentElement.setAttribute("xmlns",e.documentElement.namespaceURI),i=(new n.XMLSerializer).serializeToString(e.documentElement),h()?t?t(i):(r.util.log("Looks like your browser needs htmlparser.js as workaround for writing XML. Please include it."),i):i},d=function(){if(n.navigator.userAgent.indexOf("WebKit")>=0&&n.navigator.userAgent.indexOf("Chrome")<0)return!1;if(n.BlobBuilder||n.MozBlobBuilder||n.WebKitBlobBuilder)return!0;if(n.Blob)try{return new n.Blob(["<b></b>"],{type:"text/xml"}),!0}catch(e){return!1}return!1},v=function(e){var t="image/svg+xml;charset=utf-8",r=n.BlobBuilder||n.MozBlobBuilder||n.WebKitBlobBuilder,i;return r?(i=new r,i.append(e),i.getBlob(t)):new n.Blob([e],{type:t})},m=function(e){var t=n.URL||n.webkitURL||window;return d()?t.createObjectURL(v(e)):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)},g=function(e){var t=n.URL||n.webkitURL||window;d()&&t.revokeObjectURL(e)},y=function(e,t){var n=e.createElement(t);return n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.style.position="absolute",n.style.top="-10000px",n.style.left="-10000px",e.getElementsByTagName("body")[0].appendChild(n),n},b=function(e,t){var n=e.getElementById(t);return n||(n=y(e,"div"),n.id=t),n},w="rasterizeHTML_js_FirefoxWorkaround",E=function(){var e=n.navigator.userAgent.match(/Firefox\/(\d+).0/);return!e||!e[1]||parseInt(e[1],10)<17},S=function(e,t){var i=r.util.getConstantUniqueIdFor(e),s=t?t.ownerDocument:n.document,o;E()&&(o=b(s,w+i),o.innerHTML=e,o.className=w)},x=function(e,t){var i=r.util.getConstantUniqueIdFor(e),s=t?t.ownerDocument:n.document,o=s.getElementById(w+i);o&&o.parentNode.removeChild(o)};r.getSvgForDocument=function(e,t,n){var r=p(e);return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+n+'">'+'<foreignObject width="100%" height="100%">'+r+"</foreignObject>"+"</svg>"},r.renderSvg=function(e,t,r,i){var s,o,u=function(){o.onload=null,o.onerror=null},a=function(){s&&g(s),x(e,t)};S(e,t),s=m(e),o=new n.Image,o.onload=function(){u(),a(),r(o)},o.onerror=function(){a(),i()},o.src=s},r.drawImageOnCanvas=function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(n){return!1}return!0};var T=function(e,t,n,i,s,o){var u=r.getSvgForDocument(e,t,n),a=function(e){e.push({resourceType:"document",msg:"Error rendering page"})},f;r.renderSvg(u,i,function(e){i&&(f=r.drawImageOnCanvas(e,i),f||(a(o),e=null)),s&&s(e,o)},function(){a(o),s&&s(null,o)})};return r.drawDocument=function(t,n,i,s){var o=r.util.parseOptionalParameters(n,i,s),u=o.canvas?o.canvas.width:300,a=o.canvas?o.canvas.height:200,f=o.options.width!==undefined?o.options.width:u,l=o.options.height!==undefined?o.options.height:a,c=o.options.executeJsTimeout||0;e.inlineReferences(t,o.options,function(e){o.options.executeJs?r.util.executeJavascript(t,c,function(t,n){T(t,f,l,o.canvas,o.callback,e.concat(n))}):T(t,f,l,o.canvas,o.callback,e)})},r.drawHTML=function(e,t,i,s){var o=r.util.parseOptionalParameters(t,i,s),u=n.document.implementation.createHTMLDocument("");u.documentElement.innerHTML=e,r.drawDocument(u,o.canvas,o.options,o.callback)},r.drawURL=function(t,n,i,s){var o=r.util.parseOptionalParameters(n,i,s),u=o.options.cache;o.options.baseUrl=t,e.util.ajax(t,{cache:u},function(e){r.drawHTML(e,o.canvas,o.options,o.callback)},function(){o.callback&&o.callback(null,[{resourceType:"page",url:t,msg:"Unable to load page "+t}])})},r}(window.rasterizeHTMLInline,window.HTMLtoXML||{},window);