/*! rasterizeHTML.js - v0.1.0 - 2012-09-17
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2012 Christoph Burgmer; Licensed MIT */
var rasterizeHTML=function(e,t,n){"use strict";var r={},i=[];r.util={},r.util.getConstantUniqueIdFor=function(e){return i.indexOf(e)<0&&i.push(e),i.indexOf(e)},r.util.cloneArray=function(e){return Array.prototype.slice.apply(e,[0])},r.util.log=function(t){e.console&&e.console.log&&e.console.log(t)},r.util.joinUrl=function(e,n){var r=new t(n);return r.is("relative")&&(r=r.absoluteTo(e)),r.toString()},r.util.isDataUri=function(e){return/^data:/.test(e)},r.util.map=function(e,t,n){var i=0,s=r.util.cloneArray(e),o=[],u;s.length===0&&n(o);var a=function(e){function r(t){i+=1,o[e]=t,i===s.length&&n(o)}t(s[e],r)};for(u=0;u<s.length;u++)a(u)};var s=function(e){return e+"?_"+Date.now()};r.util.ajax=function(t,n,r,i){var o=new e.XMLHttpRequest,u;i=i||{},u=i.cache===!1?s(t):t,o.addEventListener("load",function(e){o.status===200||o.status===0?n(o.response):r()},!1),o.addEventListener("error",function(){r()},!1),o.open("GET",u,!0),o.overrideMimeType(i.mimeType);try{o.send(null)}catch(a){r()}},r.util.binaryAjax=function(e,t,n,i){var s="";i=i||{},r.util.ajax(e,function(e){for(var n=0;n<e.length;n++)s+=String.fromCharCode(e.charCodeAt(n)&255);t(s)},n,{mimeType:"text/plain; charset=x-user-defined",cache:i.cache})};var o=function(e){var t=/^"(.+)*"$/,n=/^'(.+)*'$/;return t.test(e)?e.replace(t,"$1"):n.test(e)?e.replace(n,"$1"):e};r.util.extractCssUrl=function(e){var t=/^url\(([^\)]+)\)/,n;if(!t.test(e))throw new Error("Invalid url");return n=t.exec(e)[1],o(n)};var u=function(t){var n=e.document.createElement("canvas"),r=n.getContext("2d");return n.width=t.width,n.height=t.height,r.drawImage(t,0,0),n.toDataURL("image/png")};r.util.getDataURIForImageURL=function(t,n,r,i){var o=new e.Image,a,f;i=i||{},f=i.cache===!1?s(t):t,o.onload=function(){try{a=u(o)}catch(e){r();return}n(a)},r&&(o.onerror=r),o.src=f};var a=function(e,t){return t&&t!=="about:blank"&&(e=r.util.joinUrl(t,e)),e},f=function(e){var t=new n,r=t.parse(e,!1,!0);return r},l=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspSTYLE_RULE)for(i=0;i<s.declarations.length;i++)s.declarations[i].property==="background-image"&&n.push(s.declarations[i])}return n},c=function(t){var n=[],r,i,s;for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspFONT_FACE_RULE)for(i=0;i<s.descriptors.length;i++)s.descriptors[i].property==="src"&&n.push(s.descriptors[i])}return n},h=function(){var e={baseUrl:null,options:{},callback:null};return typeof arguments[0]=="function"?e.callback=arguments[0]:typeof arguments[0]=="object"&&arguments[0]!==null?(e.options=arguments[0],e.callback=arguments[1]):(e.baseUrl=arguments[0],typeof arguments[1]=="object"&&arguments[1]!==null?(e.options=arguments[1],e.callback=arguments[2]):e.callback=arguments[1]),e},p=function(e,t,n,i,s){var o=e.attributes.src.nodeValue,u=t||e.ownerDocument.baseURI;r.util.isDataUri(o)&&i(),o=a(o,u),r.util.getDataURIForImageURL(o,function(t){e.attributes.src.nodeValue=t,i()},function(){s(o)},{cache:n})};r.loadAndInlineImages=function(e,t,n,i){var s=h(t,n,i),o=e.getElementsByTagName("img"),u=s.options.cache!==!1,a=[];r.util.map(o,function(e,t){p(e,s.baseUrl,u,t,function(e){a.push({resourceType:"image",url:e}),t()})},function(){s.callback&&s.callback(a)})};var d=function(e,t){var n;try{n=r.util.extractCssUrl(t.values[0].cssText())}catch(i){return!1}return r.util.isDataUri(n)?!1:(n=r.util.joinUrl(e,n),t.values[0].setCssText('url("'+n+'")'),!0)},v=function(e,t){var n=f(t),r=l(n),i=!1,s;for(s=0;s<r.length;s++)i=d(e,r[s])||i;return i?n.cssText():t},m=function(e,t){var n=e.createElement("style"),r=e.getElementsByTagName("head")[0];n.type="text/css",n.appendChild(e.createTextNode(t)),r.appendChild(n)},g=function(e,t,n,i,s){var o=e.attributes.href.nodeValue,u=t||e.ownerDocument.baseURI,f=a(o,u),l;r.util.ajax(f,function(t){l=v(o,t),e.parentNode.removeChild(e),i(l)},function(){s(f)},{cache:n})},y=function(e,t){var n=t.join("").trim();n&&m(e,n)};r.loadAndInlineCSS=function(e,t,n,i){var s=h(t,n,i),o=e.getElementsByTagName("link"),u=s.options.cache!==!1,a=[];r.util.map(o,function(e,t){e.attributes.rel&&e.attributes.rel.nodeValue==="stylesheet"&&(!e.attributes.type||e.attributes.type.nodeValue==="text/css")?g(e,s.baseUrl,u,function(e){e.trim()?t(e+"\n"):t("")},function(e){a.push({resourceType:"stylesheet",url:e}),t("")}):t("")},function(t){y(e,t),s.callback&&s.callback(a)})};var b=function(e,t,n,i,s){var o;try{o=r.util.extractCssUrl(e.values[0].cssText())}catch(u){i(!1);return}if(r.util.isDataUri(o)){i(!1);return}o=a(o,t),r.util.getDataURIForImageURL(o,function(t){e.values[0].setCssText('url("'+t+'")'),i(!0)},function(){s(o)},{cache:n})},w=function(e,t,n,r){var i=l(e),s=[],o;rasterizeHTML.util.map(i,function(e,r){b(e,t,n,r,function(e){s.push({resourceType:"backgroundImage",url:e}),r()})},function(e){o=e.indexOf(!0)>=0,r(o,s)})},E=function(e,t,n,i,s){var o,u;try{o=r.util.extractCssUrl(e.values[0].cssText())}catch(f){i(!1);return}if(r.util.isDataUri(o)){i(!1);return}o=a(o,t),r.util.binaryAjax(o,function(t){u=btoa(t),e.values[0].setCssText('url("data:font/woff;base64,'+u+'")'),i(!0)},function(){s(o)},{cache:n})},S=function(e,t,n,r){var i=c(e),s=[],o;rasterizeHTML.util.map(i,function(e,r){E(e,t,n,r,function(e){s.push({resourceType:"fontFace",url:e}),r()})},function(e){o=e.indexOf(!0)>=0,r(o,s)})},x=function(t,n){var r=l(n).length>0;return r&&e.navigator.userAgent.indexOf("WebKit")>=0?"span {}\n"+t:t},T=function(e,t,n,r){var i=e.textContent,s=t||e.ownerDocument.baseURI,o=f(i);w(o,s,n,function(t,u){S(o,s,n,function(n,s){if(t||n)i=o.cssText();i=x(i,o),e.childNodes[0].nodeValue=i,r(u.concat(s))})})};r.loadAndInlineCSSReferences=function(e,t,n,i){var s=h(t,n,i),o=[],u=s.options.cache!==!1,a=e.getElementsByTagName("style");r.util.map(a,function(e,t){e.attributes.type&&e.attributes.type.nodeValue==="text/css"?T(e,s.baseUrl,u,function(e){o=o.concat(e),t()}):t()},function(){s.callback&&s.callback(o)})};var N=function(){return e.navigator.userAgent.indexOf("WebKit")>=0},C=function(t){var n;return t.documentElement.setAttribute("xmlns",t.documentElement.namespaceURI),n=(new e.XMLSerializer).serializeToString(t.documentElement),N()?e.HTMLtoXML?e.HTMLtoXML(n):(r.util.log("Looks like your browser needs htmlparser.js as workaround for writing XML. Please include it."),n):n},k=function(){if(e.navigator.userAgent.indexOf("WebKit")>=0&&e.navigator.userAgent.indexOf("Chrome")<0)return!1;if(e.BlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder)return!0;if(e.Blob)try{return new e.Blob("<b></b>",{type:"text/xml"}),!0}catch(t){return!1}return!1},L=function(t){var n="image/svg+xml;charset=utf-8",r=e.BlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder,i;return r?(i=new r,i.append(t),i.getBlob(n)):new e.Blob(t,{type:n})},A=function(t){var n=e.URL||e.webkitURL||e;return k()?n.createObjectURL(L(t)):"data:image/svg+xml;charset=utf-8,"+t},O=function(t){var n=e.URL||e.webkitURL||e;k()&&n.revokeObjectURL(t)},M=function(e,t){var n=e.getElementById(t);return n||(n=e.createElement("div"),n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.style.position="absolute",n.style.top="-10000px",n.style.left="-10000px",n.id=t,e.getElementsByTagName("body")[0].appendChild(n)),n},_="rasterizeHTML_js_FirefoxWorkaround",D=function(e,t){var n=r.util.getConstantUniqueIdFor(e),i=M(e.ownerDocument,_+n);i.innerHTML=t,i.className=_},P=function(e){var t=r.util.getConstantUniqueIdFor(e),n=e.ownerDocument.getElementById(_+t);n&&e.ownerDocument.getElementsByTagName("body")[0].removeChild(n)};return r.getSvgForDocument=function(e,t,n){var r=C(e),i=t||100,s=n||100;return'<svg xmlns="http://www.w3.org/2000/svg" width="'+i+'" height="'+s+'">'+'<foreignObject width="100%" height="100%">'+r+"</foreignObject>"+"</svg>"},r.drawSvgToCanvas=function(t,n,r,i){var s,o,u,a,f=function(){u&&O(u),P(n)};D(n,t),s=n.getContext("2d"),u=A(t),a=new e.Image,a.onload=function(){try{s.drawImage(a,0,0)}catch(e){i();return}finally{f()}r&&r(n)},a.onerror=function(){f(),i()},a.src=u},r.drawDocument=function(e,t,n,i,s){var o=h(n,i,s),u=[],a;r.loadAndInlineImages(e,o.baseUrl,o.options,function(n){u=u.concat(n),r.loadAndInlineCSS(e,o.baseUrl,o.options,function(n){u=u.concat(n),r.loadAndInlineCSSReferences(e,o.baseUrl,o.options,function(n){u=u.concat(n),a=r.getSvgForDocument(e,t.width,t.height),r.drawSvgToCanvas(a,t,function(){o.callback&&o.callback(t,u)},function(){u.push({resourceType:"document"}),o.callback&&o.callback(t,u)})})})})},r.drawHTML=function(t,n,i,s,o){var u=h(i,s,o),a=e.document.implementation.createHTMLDocument("");a.documentElement.innerHTML=t,r.drawDocument(a,n,u.baseUrl,u.options,u.callback)},r.drawURL=function(e,t,n,i){var s=typeof n=="object"?i:n,o=typeof n=="object"?n:{};r.util.ajax(e,function(n){r.drawHTML(n,t,e,o,s)},function(){s&&s(t,[{resourceType:"page",url:e}])},{cache:o.cache})},r}(window,URI,CSSParser);